# Ansible playbook to establish `nginx` webserver and Emojis font.

---
- hosts: servers
  become: yes
  tasks:
    - name: Ensure `nginx` is installed
      apt:
        name: nginx
        state: present

    - name: Ensure `fonts-noto-color-emoji` is installed
      apt:
        name: fonts-noto-color-emoji
        state: present

    - name: Create `/etc/ssl/selfsigned_sert` directory
      file:
        path: /etc/ssl/selfsigned_sert
        state: directory
        # owner: www-data
        # group: www-data
        mode: 0775
        recurse: yes

    # - name: Ensure required packages are installed
    #   apt:
    #     name: ['build-essential', 'libssl-dev', 'libffi-dev', 'python3-dev',
    #       'python3-pip', 'python-setuptools', 'cargo']
    #     state: present

    # - name: Install `PyOpenSSL`
    #   pip:
    #     name: PyOpenSSL
    #     state: present

    # - name: Generate an OpenSSL private key
    #   openssl_privatekey:
    #     path: /etc/ssl/selfsigned_sert/privkey.pem

    # - name: Generate an OpenSSL CSR
    #   openssl_csr:
    #     path: /etc/ssl/selfsigned_sert/cert_req.csr
    #     privatekey_path: /etc/ssl/selfsigned_sert/privkey.pem
    #     common_name: "Simple sertificate"

    # - name: Generate a Self Signed OpenSSL certificate
    #   openssl_certificate:
    #     path: /etc/ssl/selfsigned_sert/sert.crt
    #     privatekey_path: /etc/ssl/selfsigned_sert/privkey.pem
    #     csr_path: /etc/ssl/selfsigned_sert/cert_req.csr
    #     provider: selfsigned

    - name: Remove `default` site from `sites-enabled`
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: Copy `nginx.conf` to `sites-available` with name `my_service`
      copy:
        src: nginx.conf
        dest: /etc/nginx/sites-available/my_service

    - name: Create symlink `my_service` config to `sites-enabled`
      file:
        src: /etc/nginx/sites-available/my_service
        dest: /etc/nginx/sites-enabled/my_service
        state: link

    - name: Create `/var/www/my_service` directory for service files
      file:
        path: /var/www/my_service
        state: directory
        # owner: www-data
        # group: www-data
        mode: 0775
        recurse: yes

    - name: Copy `index.html`
      copy:
        src: index.html
        dest: /var/www/my_service/

    - name: Ensure `openssl` is installed
      apt:
        name: openssl
        state: present

    - name: Generate ssl selfsigned sertificate
      shell: "openssl req -newkey rsa:2048 -x509 -sha256 -days 30 -nodes \
              -out /etc/ssl/selfsigned_sert/sert.crt \
              -keyout /etc/ssl/selfsigned_sert/privkey.pem \
              -subj '/C=RU/ST=Tatarstan/L=Kazan/O=Andersen DevOps courses/\
              OU=Andrei Bulgakov/CN='"

    - name: Ensure `nginx` is running
      service:
        name: nginx
        state: started
        enabled: yes
